---
title: "Analyze Polly Telemetry using OpenTelemetry Metrics"
date: 2023-10-25T12:25:31+02:00
draft: true
description: "Starting with version 8, Polly provides telemetry for all built-in resilience strategies. This post will demonstrate how to send this telemetry to Prometheus for more in-depth analysis using OpenTelemetry Metrics."
tags: ["dotnet", "otel", "metrics"]
---

This post does not aim to be an introductory post on how the Polly library works, how to configure its various policies, etc. There are already multiple posts on the Internet that explain these topics very well.

The goal of this post is to demonstrate **how we can use OpenTelemetry Metrics to send the telemetry generated by Polly to Prometheus for subsequent analysis by setting up a series of dashboards in Grafana**.

It's important to mention that Polly provides telemetry for all built-in resilience strategies starting with version 8. It's crucial to emphasize that **this post does not work with versions of Polly earlier than version 8**.

# **What is Polly?**

Polly is a .NET library that aids in building resilient and fault-tolerant applications. 

It is primarily used for improving the stability and resilience of a .NET application by handling transient faults, system failures, and network outages. The library helps developers implement various resilience patterns, such as retries, circuit breakers, and timeouts, to improve the reliability of your applications.

- Would you like to learn more about it? Visit its official [Github repository](https://github.com/App-vNext/Polly)


# **How to enable Telemetry on Polly**

Polly 8 was released a few weeks ago, and it now offers telemetry for all its built-in resilience strategies.

Polly Telemetry is disabled by default, to enable it you need to install the ``Polly.Extensions`` NuGet package and use the ``ConfigureTelemetry`` extension method on a ``ResiliencePipelineBuilder``.

```csharp
var builder = new ResiliencePipelineBuilder()
    .AddTimeout(TimeSpan.FromSeconds(1))
    .ConfigureTelemetry(new NullLoggerFactory())
    .Build();
```

The ``ConfigureTelemetry`` extension method can be configured in a couple different ways:

- To accept an ``ILoggerFactory`` instance
```csharp
public static TBuilder ConfigureTelemetry<TBuilder>(this TBuilder builder, ILoggerFactory loggerFactory)
        where TBuilder : ResiliencePipelineBuilderBase
    {
        Guard.NotNull(builder);
        Guard.NotNull(loggerFactory);

        return builder.ConfigureTelemetry(new TelemetryOptions { LoggerFactory = loggerFactory });
    }
```

- To accept a ``TelemetryOptions`` instance:

```csharp
public static TBuilder ConfigureTelemetry<TBuilder>(this TBuilder builder, TelemetryOptions options)
    where TBuilder : ResiliencePipelineBuilderBase
{
    Guard.NotNull(builder);
    Guard.NotNull(options);

    ValidationHelper.ValidateObject(new(options, $"The '{nameof(TelemetryOptions)}' are invalid."));
    builder.TelemetryListener = new TelemetryListenerImpl(options);

    return builder;
}
```

# **Polly metrics**

Let's see which metrics does Polly emit.

## **Instrument: `resilience.polly.strategy.events`**

- Type: *Counter*
- Numerical type of measurement: *int*
- Description: Emitted upon the occurrence of a resilience event.

Tags:

|Name|Description|
|---| ---|
|`event.name`| The name of the emitted event.|
|`event.severity`| The severity of the event (`Debug`, `Information`, `Warning`, `Error`, `Critical`).|
|`pipeline.name`| The name of the pipeline corresponding to the resilience pipeline.|
|`pipeline.instance`| The instance name of the pipeline corresponding to the resilience pipeline.|
|`strategy.name`| The name of the strategy generating this event.|
|`operation.key`| The operation key associated with the call site. |
|`exception.type`| The full name of the exception assigned to the execution result (`System.InvalidOperationException`). |

#### Event names

The `event.name` tag is reported by individual resilience strategies. The built-in strategies report the following events:

- `OnRetry`
- `OnFallback`
- `OnHedging`
- `OnTimeout`
- `OnCircuitClosed`
- `OnCircuitOpened`
- `OnCircuitHalfOpened`
- `OnRateLimiterRejected`

## Instrument: `resilience.polly.strategy.attempt.duration`

- Type: *Histogram*
- Unit: *milliseconds*
- Numerical type of measurement: *double*
- Description: Tracks the duration of execution attempts, produced by `Retry` and `Hedging` resilience strategies.

Tags:

|Name|Description|
|---| ---|
|`event.name`| The name of the emitted event. Currently, the event name is always `ExecutionAttempt`. |
|`event.severity`| The severity of the event (`Debug`, `Information`, `Warning`, `Error`, `Critical`).|
|`pipeline.name`| The name of the pipeline corresponding to the resilience pipeline.|
|`pipeline.instance`| The instance name of the pipeline corresponding to the resilience pipeline.|
|`strategy.name`| The name of the strategy generating this event.|
|`operation.key`| The operation key associated with the call site. |
|`exception.type`| The full name of the exception assigned to the execution result (`System.InvalidOperationException`). |
|`attempt.number`| The execution attempt number, starting at 0 (0, 1, 2, etc.). |
|`attempt.handled`| Indicates if the execution outcome was handled. A handled outcome indicates execution failure and the need for retry (`true`, `false`). |

## Instrument: `resilience.polly.pipeline.duration`

- Type: *Histogram*
- Unit: *milliseconds*
- Numerical type of measurement: *double*
- Description: Measures the duration of resilience pipelines.

Tags:

|Name|Description|
|---| ---|
|`pipeline.name`| The name of the pipeline corresponding to the resilience pipeline.|
|`pipeline.instance`| The instance name of the pipeline corresponding to the resilience pipeline.|
|`operation.key`| The operation key associated with the call site. |
|`exception.type`| The full name of the exception assigned to the execution result (`System.InvalidOperationException`). |


# **Demo**

The following diagram shows what we're going to build in this post.

![polly-metrics-components-diagram](/img/polly-metrics-components-diagram.png)

- A .NET WebAPI uses the OpenTelemetry OTLP exporter package (OpenTelemetry.Exporter.OpenTelemetryProtocol) to send the Polly telemetry to the OpenTelemetry Collector.
- The Prometheus server obtains the metric data from the OpenTelemetry Collector.
- The Grafana server comes preconfigured with a few dashboards to visualize the OpenTelemetry metrics emitted by the BookStore WebApi.