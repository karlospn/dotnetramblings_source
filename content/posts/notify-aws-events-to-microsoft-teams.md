---
title: "How to notify AWS Events to Microsoft Teams using AWS EventBridge and AWS Lambda"
date: 2022-10-14T12:28:12+02:00
tags: ["aws", "eventbridge", "lambda", "teams", "python", "cdk", "iac", "devops"]
description: "TBD"
draft: true
---

> **Just show me the code!**   
> As always, if you donâ€™t care about the post I have uploaded the source code on my [Github](https://github.com/karlospn/notify-aws-events-to-microsoft-teams).

An AWS event indicates a change in a service, a SaaS partner service or application. The following are examples of AWS events:

- Amazon EC2 generates an event when the state of an instance changes from pending to running.
- Amazon EC2 Auto Scaling generates events when it launches or terminates instances.
- AWS EC2 generates an event when you push a new image into an ECR Repository.

In this post I want to show you how you can notify those AWS events to a Microsoft Teams channel using AWS EventBridge and AWS Lambda.


# **AWS EventBridge**

Amazon EventBridge is a serverless event bus service. 

How it works? To put it simply, when EventBridge receives an event, it applies a rule that routes the event to a specific target.  

All events that come to EventBridge are associated with an event bus. Rules are tied to a single event bus, so they can only be applied to events on that event bus.   
Any AWS account has a **default event bus which receives events from AWS services**.

Here's the full list of AWS services that generates events that EventBridge can receive:
- https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-service-event.html

Events are represented as JSON objects and they all have a similar structure.

The contents of the "detail" top-level field are different depending on which service generated the event and what the event is.    
The combination of the "source" and "detail-type" fields serves to identify the fields and values found in the "detail" field.   

Here's an example of how event generated by ECR looks like:
```javascript
{
    "version": "0",
    "id": "71c174a2-6a18-8c75-6109-6546a541b54d",
    "detail-type": "ECR Image Action",
    "source": "aws.ecr",
    "account": "935156053038",
    "time": "2022-10-10T13:11:49Z",
    "region": "eu-west-1",
    "resources": [],
    "detail": {
        "result": "SUCCESS",
        "repository-name": "demo",
        "image-digest": "sha256:93648920bded8c34263deb2063b52c99a847c2af5e25c8a979b17f8aa66a4564",
        "action-type": "PUSH",
        "image-tag": "1.1.0"
    }
}
```

# **Architecture Diagram**

The setup to notify an AWS Event to Microsoft Teams using AWS EventBridge and Lambda is really simple:

![notify-aws-event-to-teams-diagram](/img/notify-aws-event-to-teams-diagram.png)

- An ``AWS EventBridge Rule`` matches a specific set of AWS events and sends them to a target.
- The target is a ``Lambda function`` that sends the event to a ``Microsoft Teams Channel`` using an ``incoming HTTP WebHook``.

# **Setting up an AWS EventBridge Rule**

First step is to decide which AWS events we want to listen to on our ``EventBridge Rule``.

In this post I'll be listening to ``ECR PUSH events``, so everytime a new container image or tag gets pushed to any ``ECR repository`` a notification pops on my Teams Chanel.


The next code snippet shows how to create an ``EventBridge Rule`` that listens to ``ECR Push Events``. I'm using  [AWS CDK](https://aws.amazon.com/cdk/?nc1=h_ls).

```csharp
var bus = EventBus.FromEventBusName(this,
    "default-event-bus",
    "default");

var rule = new Rule(this, 
    "rule-notify-ecr-push-img", 
    new RuleProps
{
    EventBus = bus,
    Description = "Sent a teams notification via lambda when an ECR push event is generated.",
    RuleName = "rule-ecr-push-image-teams-notification",
    Enabled = true,
    EventPattern = new EventPattern
    {
        Source = new []{"aws.ecr"},
        DetailType = new []{"ECR Image Action"},
        Detail = new Dictionary<string, object>
        {
            {"action-type", new[]{"PUSH"} },
            {"result", new[]{"SUCCESS"} },
        }
    }
});
```

The important part is the "EventPattern" block. 
- ``Source``: Identifies the service that sourced the event.
- ``DetailType``: The type of event.
- ``Detail``: A JSON object, whose content is at the discretion of the service originating the event. In this case, I want push actions that ended up being succesful.

The easiest way of knowing which values use for the "DetailType" or the "Detail" attributes is to use the AWS Portal. An EventPattern builder is availaible on the AWS Portal when you try to create an EventBridge Rule.

<add-img>

If you're using IaC to create those EventBridge Rules, the best way to do it is using first the AWS Portal to create the EventPattern expression and then move it into your IaC files.

# **Building the Lambda function Target**

A target is a resource or endpoint that EventBridge sends an event to when the event matches the event pattern defined for a rule. 

The Lambda function only has to do one thing:
- Get the event sent by the EventBridge Rule and send it to Teams using an HTTP WebHook.

This time instead of dotnet I'll be using Python. For this kind of functions, Python is a better and cheaper option.

```python
import json
import os
import logging
import urllib.request
from urllib.error import URLError, HTTPError

logger = logging.getLogger()
logger.setLevel(logging.DEBUG)

def lambda_handler(event, context):   
    try:       
        data = json.dumps(event)
        msg = {
            'text': data
        }    
        response = urllib.request.urlopen(urllib.request.Request(os.environ['teams_webhook_uri'], json.dumps(msg).encode('utf-8')))
        response.read()
    except HTTPError as err:
        logger.error(f"Request failed: {err.code} {err.reason}")
    except URLError as err:
        logger.error(f"Server connection failed: {err.reason}")
```
The function can be as simple as the above code snippet, it only needs to stringify the event object and send it to Teams via HTTP.   
If we take a look at the end result on Teams, it doesn't look very nice.

<add-img>

We can improve it using **Adaptative Cards for Microsoft Teams**.

## **Adaptative Cards for Microsoft Teams**
Adaptive Cards are a platform-agnostic method of displaying blocks of information without the complexity of customizing CSS or HTML to render them. 

Adaptive Cards are in JSON format and when delivered to Microsoft Teams, the JSON is transformed into native UI that automatically adapts its looks. 

If you want to know more about it, you can read it in the following links:
- https://learn.microsoft.com/en-us/power-automate/overview-adaptive-cards
- https://learn.microsoft.com/en-us/microsoftteams/platform/task-modules-and-cards/cards/design-effective-cards?tabs=design
- https://learn.microsoft.com/en-us/microsoftteams/platform/task-modules-and-cards/cards-and-task-modules

The next code snippet shows how you can build an adaptative card on the Lambda function, instead of using directly the event.

```python
import json
import os
import logging
import urllib.request
from urllib.error import URLError, HTTPError

logger = logging.getLogger()
logger.setLevel(logging.DEBUG)

def lambda_handler(event, context):   
    try:
        msg = {
                "type": "message",
                "attachments": [
                    {
                        "contentType": "application/vnd.microsoft.card.adaptive",
                        "content": {
                            "type": "AdaptiveCard",
                            "body": [
                            {
                                "type": "TextBlock",
                                "size": "High",
                                "weight": "Bolder",
                                "text": "New ECR image available"
                            },
                            {
                                "type": "FactSet",
                                "facts": [
                                    {
                                        "title": "Image Name:",
                                        "value": f"{event['detail']['repository-name']}"
                                    },
                                    {
                                        "title": "Version Tag:",
                                        "value": f"{event['detail']['image-tag']}"
                                    }
                                ]
                            }
                            ],
                            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                            "version": "1.0",
                            "msteams": {
                            "width": "Full"
                            }
                        }
                    }
                ]
            }
        
        response = urllib.request.urlopen(urllib.request.Request(os.environ['teams_webhook_uri'], json.dumps(msg).encode('utf-8')))
        response.read()
    except HTTPError as err:
        logger.info(err)
        logger.error(f"Request failed: {err.code} {err.reason}")
    except URLError as err:
        logger.error(f"Server connection failed: {err.reason}")
```

If we take a look at Teams, the end result looks much better:

<add-img>

# **How to test it**

