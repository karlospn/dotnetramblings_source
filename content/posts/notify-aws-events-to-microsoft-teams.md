---
title: "How to notify AWS Events to Microsoft Teams using AWS EventBridge and AWS Lambda"
date: 2022-10-14T12:28:12+02:00
tags: ["aws", "eventbridge", "lambda", "teams", "python", "cdk", "iac", "devops"]
description: "TBD"
draft: true
---

> **Just show me the code!**   
> As always, if you donâ€™t care about the post I have uploaded the source code on my [Github](https://github.com/karlospn/notify-aws-events-to-microsoft-teams).

An AWS event indicates a change in a service, a SaaS partner service or application. The following are examples of AWS events:

- Amazon EC2 generates an event when the state of an instance changes from pending to running.
- Amazon EC2 Auto Scaling generates events when it launches or terminates instances.
- AWS EC2 generates an event when you push a new image into an ECR Repository.

And in this post I'm going to show you how you can notify those AWS events to a Microsoft Teams channel using AWS EventBridge and AWS Lambda.


# **AWS EventBridge**

Amazon EventBridge is a serverless event bus service. 

How it works? To put it simply, when EventBridge receives an event, it applies a rule to route the event to a specific target.  

Many AWS services generate events and EventBridge receives them. When an AWS service in one of your accounts emits an event, it goes straight to the EventBridge default event bus.

Here's the full list of AWS services that generate events that EventBridge can receive:
- https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-service-event.html

Events are represented as JSON objects and they all have a similar structure.

The contents of the detail top-level field are different depending on which service generated the event and what the event is.    
The combination of the source and detail-type fields serves to identify the fields and values found in the detail field.   

Here's an example of how event generated by ECR looks like:


```javascript
{
    "version": "0",
    "id": "71c174a2-6a18-8c75-6109-6546a541b54d",
    "detail-type": "ECR Image Action",
    "source": "aws.ecr",
    "account": "935156053038",
    "time": "2022-10-10T13:11:49Z",
    "region": "eu-west-1",
    "resources": [],
    "detail": {
        "result": "SUCCESS",
        "repository-name": "demo",
        "image-digest": "sha256:93648920bded8c34263deb2063b52c99a847c2af5e25c8a979b17f8aa66a4564",
        "action-type": "PUSH",
        "image-tag": "1.1.0"
    }
}
```

# **Architecture Diagram**

The setup to notify an AWS Event to Microsoft Teams using AWS EventBridge and Lambda is really simple:

![notify-aws-event-to-teams-diagram](/img/notify-aws-event-to-teams-diagram.png)

- An AWS EventBridge Rule matches a specific set of AWS events and sends them to a Lambda function.
- The Lambda function sends the event to a Microsoft Teams Channel using an incoming HTTP WebHook.

# **Setting up the AWS EventBridge Rule**

# **Building the Lambda function**

```python
import json
import os
import logging
import urllib.request
from urllib.error import URLError, HTTPError

logger = logging.getLogger()
logger.setLevel(logging.DEBUG)

def lambda_handler(event, context):   
    try:       
        data = json.dumps(event)
        msg = {
            'text': data
        }    
        response = urllib.request.urlopen(urllib.request.Request(os.environ['teams_webhook_uri'], json.dumps(msg).encode('utf-8')))
        response.read()
    except HTTPError as err:
        logger.error(f"Request failed: {err.code} {err.reason}")
    except URLError as err:
        logger.error(f"Server connection failed: {err.reason}")
```

```python
import json
import os
import logging
import urllib.request
from urllib.error import URLError, HTTPError

logger = logging.getLogger()
logger.setLevel(logging.DEBUG)

def lambda_handler(event, context):   
    try:
        msg = {
                "type": "message",
                "attachments": [
                    {
                        "contentType": "application/vnd.microsoft.card.adaptive",
                        "content": {
                            "type": "AdaptiveCard",
                            "body": [
                            {
                                "type": "TextBlock",
                                "size": "High",
                                "weight": "Bolder",
                                "text": "New ECR image available"
                            },
                            {
                                "type": "FactSet",
                                "facts": [
                                    {
                                        "title": "Image Name:",
                                        "value": f"{event['detail']['repository-name']}"
                                    },
                                    {
                                        "title": "Version Tag:",
                                        "value": f"{event['detail']['image-tag']}"
                                    }
                                ]
                            }
                            ],
                            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                            "version": "1.0",
                            "msteams": {
                            "width": "Full"
                            }
                        }
                    }
                ]
            }
        
        response = urllib.request.urlopen(urllib.request.Request(os.environ['teams_webhook_uri'], json.dumps(msg).encode('utf-8')))
        response.read()
    except HTTPError as err:
        logger.info(err)
        logger.error(f"Request failed: {err.code} {err.reason}")
    except URLError as err:
        logger.error(f"Server connection failed: {err.reason}")
```

# **How to test it**